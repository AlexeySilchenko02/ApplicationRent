@model ChangePasswordViewModel

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<main class="main">
    <h2>Изменить пароль</h2>

    <div id="successMessage" class="alert alert-success" style="display: none;">
        Пароль успешно изменен.
    </div>

    <form asp-action="ChangePassword" method="post" id="changePasswordForm">
        <div class="form-group">
            <label asp-for="OldPassword">Текущий пароль</label>
            <input asp-for="OldPassword" class="form-control" id="OldPassword" />
            <span class="text-danger" id="errorOldPassword"></span>
            <button type="button" onclick="togglePasswordVisibility('OldPassword')">Показать</button>
        </div>
        <div class="form-group">
            <label asp-for="NewPassword">Новый пароль</label>
            <input asp-for="NewPassword" class="form-control" id="NewPassword" />
            <span class="text-danger" id="errorNewPassword"></span>
            <button type="button" onclick="togglePasswordVisibility('NewPassword')">Показать</button>
        </div>
        <div class="form-group">
            <label asp-for="ConfirmPassword">Подтвердите новый пароль</label>
            <input asp-for="ConfirmPassword" class="form-control" id="ConfirmPassword" />
            <span class="text-danger" id="errorConfirmPassword"></span>
            <button type="button" onclick="togglePasswordVisibility('ConfirmPassword')">Показать</button>
        </div>
        <button type="submit" class="btn btn-primary">Изменить пароль</button>
    </form>

    <button type="button" class="btn btn-secondary" onclick="window.location.href='@Url.Action("Index", "UserProfile")';">Вернуться в личный кабинет</button>

    <script>
        function togglePasswordVisibility(fieldId) {
            var input = document.getElementById(fieldId);
            if (input.type === "password") {
                input.type = "text";
                document.querySelector(`button[onclick="togglePasswordVisibility('${fieldId}')"]`).textContent = "Скрыть";
            } else {
                input.type = "password";
                document.querySelector(`button[onclick="togglePasswordVisibility('${fieldId}')"]`).textContent = "Показать";
            }
        }
    </script>
    <script>
        $(document).ready(function () {
            $('#changePasswordForm').submit(function (event) {
                event.preventDefault();
                var formData = $(this).serializeArray();
                var hasErrors = false;

                // Очистка предыдущих ошибок
                $('.text-danger').empty();
                $('#successMessage').hide(); // Скрыть предыдущее успешное сообщение

                // Проверка заполненности всех полей
                formData.forEach(function (item) {
                    if (!item.value) {
                        $('#error' + item.name).text('Заполните данное поле');
                        hasErrors = true;
                    }
                });

                // Проверка совпадения паролей
                var newPassword = formData.find(x => x.name === 'NewPassword')?.value;
                var confirmPassword = formData.find(x => x.name === 'ConfirmPassword')?.value;
                if (newPassword && confirmPassword && newPassword !== confirmPassword) {
                    $('#errorNewPassword').text('Пароли не совпадают');
                    $('#errorConfirmPassword').text('Пароли не совпадают');
                    hasErrors = true;
                }

                if (hasErrors) return; // Прерывание, если есть ошибки

                // Отправка данных на сервер
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: $.param(formData),
                    success: function (response) {
                        if (response.success) {
                            $('#successMessage').show(); // Показать сообщение об успехе
                            $('#changePasswordForm').trigger('reset'); // Очистка формы
                        } else {
                            response.errors.forEach(function (error) {
                                // Отображение ошибок от сервера
                                $('#error' + error.field).text(error.message);
                            });
                        }
                    },
                    error: function () {
                        alert('Произошла ошибка при отправке формы.');
                    }
                });
            });
        });
    </script>
</main>
