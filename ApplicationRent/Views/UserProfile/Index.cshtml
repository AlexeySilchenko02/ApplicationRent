@model UserProfileViewModel
@using System.Globalization

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<main class="main">
    <h2>Личный кабинет пользователя: @Model.User.FullNameUser</h2>
    @* <p>Баланс: <span id="user-balance">@Model.User.Balance.ToString("C")</span></p> *@
    <p>Баланс: <span id="user-balance">@Model.User.Balance.ToString("C", new CultureInfo("ru-RU"))</span></p>
    <a href="@Url.Action("TopUpBalance", "UserProfile")" class="btn btn-secondary">Пополнить баланс</a>
    <a href="@Url.Action("TransactionHistory", "UserProfile")" class="btn btn-secondary">История транзакций</a>
    <form id="updateUserProfileForm" asp-action="UpdateUserProfile" method="post" onsubmit="updateUserProfile(event)">
        <div class="form-group">
            <label for="FullNameUser">Полное имя</label>
            <input type="text" class="form-control" id="FullNameUser" name="FullNameUser" value="@Model.User.FullNameUser" required>
        </div>
        <div class="form-group">
            <label for="Email">Email</label>
            <input type="email" class="form-control" id="Email" name="Email" value="@Model.User.Email" required>
            <div id="emailError" class="text-danger" style="display:none;"></div>
        </div>
        <div class="form-group">
            <label for="PhoneNumber">Телефонный номер</label>
            <input type="tel" class="form-control" id="PhoneNumber" name="PhoneNumber" value="@Model.User.PhoneNumber" required>
        </div>
        <button type="submit" class="btn btn-primary">Обновить</button>
    </form>
    <a href="@Url.Action("ChangePassword", "UserProfile")" class="btn btn-secondary">Изменить пароль</a>
    @if (Model.Rentals.Any())
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Место</th>
                    <th>Начало аренды</th>
                    <th>Окончание аренды</th>
                    <th>Продление аренды</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var rental in Model.Rentals)
                {
                    <tr>
                        <td>@rental.Place.Name</td>
                        <td>@rental.StartRent.ToString("dd.MM.yyyy")</td>
                        <td>@rental.EndRent.ToString("dd.MM.yyyy")</td>
                        <td>
                            <button type="button" onclick="toggleForm('@rental.Id')">Продлить аренду</button>
                            <form id="form-@rental.Id" style="display:none;" data-endrent="@rental.EndRent.ToString("yyyy-MM-dd")">
                                <input type="hidden" name="rentalId" value="@rental.Id" />
                                <input type="date" name="newEndDate" onchange="calculateCost(@rental.Id, @rental.Place.Price)" />
                                <p id="cost-text-@rental.Id" style="display:none;">Стоимость: <span id="cost-@rental.Id">0</span></p>
                                <button type="button" onclick="extendRent(@rental.Id, @rental.Place.Price)">Обновить</button>
                                <div id="error-@rental.Id" class="text-danger" style="display:none;"></div>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>У вас нет актуальных мест аренды.</p>
    }
</main>

<script>
    function updateUserProfile(event) {
        // Предотвращаем действие по умолчанию (отправку формы)
        event.preventDefault();
        var form = document.getElementById('updateUserProfileForm');
        var formData = new FormData(form);

        // Отправляем AJAX-запрос
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            }
        })
            .then(response => {
                if (response.ok) {
                    // Если ответ успешен, перезагружаем страницу
                    window.location.reload();
                } else if (response.status === 400) {
                    // Если ответ содержит ошибку 400 (неверные данные), обрабатываем ошибку
                    response.json().then(data => {
                        if (data.errors) {
                            // Скрываем все старые ошибки
                            document.querySelectorAll('.text-danger').forEach(element => {
                                element.style.display = 'none';
                            });

                            // Если есть ошибки, отображаем их
                            for (var key in data.errors) {
                                var errorElement = document.getElementById(key + 'Error');
                                if (errorElement) {
                                    errorElement.innerText = data.errors[key];
                                    errorElement.style.display = 'block';
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error:', error));
    }
    function toggleForm(rentalId) {
        var form = document.getElementById('form-' + rentalId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
            var endRent = form.getAttribute('data-endrent');
            form.elements['newEndDate'].value = endRent;
        } else {
            form.style.display = 'none';
        }
    }

    function calculateCost(rentalId, monthlyPrice) {
        var form = document.getElementById('form-' + rentalId);
        var newEndDate = new Date(form.elements['newEndDate'].value);
        var currentEndDate = new Date(form.getAttribute('data-endrent'));

        var diffTime = Math.abs(newEndDate - currentEndDate);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        var dailyPrice = monthlyPrice / 28;
        var cost = diffDays * dailyPrice;

        document.getElementById('cost-' + rentalId).innerText = cost.toFixed(2);
        document.getElementById('cost-text-' + rentalId).style.display = 'block';
    }

    function extendRent(rentalId, monthlyPrice) {
        var form = document.getElementById('form-' + rentalId);
        var newEndDate = form.elements['newEndDate'].value;
        var cost = parseFloat(document.getElementById('cost-' + rentalId).innerText);

        fetch('/UserProfile/UpdateRentalEndDate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                rentalId: rentalId,
                newEndDate: newEndDate,
                cost: cost
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    var errorElement = document.getElementById('error-' + rentalId);
                    errorElement.innerText = data.error;
                    errorElement.style.display = 'block';
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
